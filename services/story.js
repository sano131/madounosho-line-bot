import { ChatOpenAI } from '@langchain/openai'
import { HumanMessage, SystemMessage } from '@langchain/core/messages'

const chat = new ChatOpenAI({
  temperature: 0.85,
  modelName: 'gpt-4o',
})

const systemPrompt = `
ã‚ãªãŸã¯ç•°ä¸–ç•Œãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼å°èª¬ã®åä½œå®¶ã§ã™ã€‚

èˆžå°ã¯ã€Œã‚¨ãƒ«ãƒ‡ã‚£ãƒŠãƒ»ã‚¢ãƒ¼ã‚¯ã€â”€â”€  
äº”ã¤ã®ç¨®æ—ãŒä½ã¾ã†é­”æ³•ã¨å‰£ã®å¤§é™¸ã€‚  
ç¥žè–ãªæ£®ã€Œã‚»ãƒªã‚¹ãƒ´ã‚§ã‚¤ãƒ«ã€ã«ã¯ã‚¨ãƒ«ãƒ•æ—ãŒæ²»ã‚ã‚‹çŽ‹å›½ãŒã‚ã‚Šã€ç™½éŠ€ã®å¥³çŽ‹ã€Œãƒªãƒ¥ã‚·ã‚¢ï¼ã‚¨ãƒ«ãƒ•ã‚£ãƒ¼ãƒã€ãŒãã®é ‚ç‚¹ã«ç«‹ã£ã¦ã„ã‚‹ã€‚

ã“ã®ä¸–ç•Œã¯ã€åƒå¹´å‰ã«å°å°ã•ã‚ŒãŸé­”å°Žç½åŽ„ã€Œæ·±æ·µã®ç˜´æ°—ã€ãŒå†ã³åœ°ä¸Šã«ã‚ãµã‚Œå‡ºã—ã€é­”åŠ›ã®ç•°å¸¸ã¨é­”ç‰©ã®å‡ºç¾ãŒåºƒãŒã£ã¦ã„ã‚‹ã€‚

èª­è€…ã¯ã€Œç•°ä¸–ç•ŒãƒŽæ›¸ã€ã«é¸ã°ã‚ŒãŸâ€œå°Žãæ‰‹â€ã¨ã—ã¦ã€10ç« ã«ã‚ãŸã‚Šç•°ä¸–ç•Œã‚’æ—…ã—ã€ã“ã®ä¸–ç•Œã®é‹å‘½ã«é–¢ã‚ã‚‹é‡è¦ãªé¸æŠžã‚’è¿«ã‚‰ã‚Œã‚‹ã€‚

---

ã€ç™»å ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‘

ðŸ‘‘ ãƒªãƒ¥ã‚·ã‚¢ï¼ã‚¨ãƒ«ãƒ•ã‚£ãƒ¼ãƒï¼ˆLucia Elphineï¼‰  
ã‚¨ãƒ«ãƒ•çŽ‹å›½ã€Œã‚»ãƒªã‚¹ãƒ´ã‚§ã‚¤ãƒ«ã€ã®è‹¥ãå¥³çŽ‹ã€‚ç™½éŠ€ã®é«ªã¨æ·±ç¢§ã®çž³ã‚’æŒã¡ã€æµ„åŒ–ã¨ç²¾éœŠã¨ã®å¯¾è©±ã®åŠ›ã‚’æ“ã‚‹ã€‚æ°‘ã¨è‡ªç„¶ã‚’å®ˆã‚‹ãŸã‚ã€ç˜´æ°—ã®ç•°å¤‰ã«è‡ªã‚‰ç«‹ã¡å‘ã‹ã†è¦šæ‚Ÿã‚’æŒã¤ã€‚

âš”ï¸ ãƒŽã‚¢ï¼ãƒ´ã‚¡ãƒ«ãƒãƒ«ãƒˆï¼ˆNoa Valhaltï¼‰  
å…ƒãƒ»å¸å›½è¿‘è¡›é¨Žå£«å›£é•·ã®å¥³æ€§å‰£å£«ã€‚ç¾åœ¨ã¯æ”¾æµªã®å‚­å…µã¨ã—ã¦ãƒªãƒ¥ã‚·ã‚¢ã«å¾“ã†ã€‚å†·é™æ²ˆç€ã§ã€éŽåŽ»ã«é‡ã„ç½ªã‚’èƒŒè² ã£ã¦ãŠã‚Šã€ãã®è´–ç½ªã®æ—…ã¨ã—ã¦ã“ã®å†’é™ºã«èº«ã‚’æŠ•ã˜ã¦ã„ã‚‹ã€‚

ðŸŒ¸ ãƒ•ã‚£ãƒ¼ãƒï¼ˆFineï¼‰  
å°ã•ãªå¦–ç²¾æ—ã®å¨˜ã€‚èŠ±ã®é­”åŠ›ã‚’æ“ã‚‹æ˜Žã‚‹ãç„¡é‚ªæ°—ãªå­˜åœ¨ã€‚ç”˜ãˆã‚“åŠã ãŒã€ç²¾éœŠã®è¨˜æ†¶ã‚’èª­ã‚€åŠ›ã¨ã€æœªæ¥ã®å¯èƒ½æ€§ã‚’æ„Ÿã˜å–ã‚‹ç‰¹åˆ¥ãªè³‡è³ªã‚’æŒã¤ã€‚

---

ç‰©èªžã¯ç« ã”ã¨ã«èª­ã¿æ‰‹ã®é¸æŠžã§åˆ†å²ã—ã€10ç« ã§å¿…ãšå®Œçµã—ã¾ã™ã€‚

æ¯Žç« ã®çµ‚ã‚ã‚Šã«ã€2ã¤ã®é¸æŠžè‚¢ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚  
ãã‚Œãžã‚Œã®é¸æŠžè‚¢ã¯13æ–‡å­—ä»¥å†…ã®è‡ªç„¶ãªæ—¥æœ¬èªžæ–‡ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚  
è¨˜å·ï¼ˆä¾‹ï¼šã€ã€‘ã€A: B:ãªã©ï¼‰ã¯ä½¿ã‚ãšã€é¸æŠžè‚¢ã®ã¿ã‚’æ–‡ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã€ç™»å ´äººç‰©ãŒç‰©èªžã«åˆã‚ã¦ç™»å ´ã™ã‚‹å ´åˆã«ã¯ã€  
èª­è€…ãŒè‡ªç„¶ã«ç†è§£ã§ãã‚‹ã‚ˆã†ã«ç°¡å˜ãªäººç‰©ç´¹ä»‹ã‚’ç‰©èªžã®æµã‚Œã®ä¸­ã«å«ã‚ã¦ãã ã•ã„ã€‚
`

export async function generateStory(chapter, userChoice) {
  const messages = [
    new SystemMessage(systemPrompt),
    new HumanMessage(
      `ç¬¬${chapter}ç« ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’æã„ã¦ãã ã•ã„ã€‚å‰ç« ã®é¸æŠžã¯ã€Œ${userChoice || 'æœ€åˆã®å‡ºä¼šã„'}ã€ã§ã™ã€‚

- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æœ¬æ–‡ï¼ˆ500æ–‡å­—ç¨‹åº¦ï¼‰
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã‚’å«ã‚ã¦ãã ã•ã„
- æœ€å¾Œã«å¿…ãšã€2ã¤ã®é¸æŠžè‚¢ã®ã¿ã‚’æç¤ºã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œæ£®ã‚’é€²ã‚€ã€ã€ŒåŸŽã¸æˆ»ã‚‹ã€ãªã©ï¼‰`
    ),
  ]

  const response = await chat.call(messages)
  const text = response.content

  const [story, optionAText, optionBText] = text.split(/\n/).reduce(
    (acc, line) => {
      if (!acc[0] && line.trim()) {
        acc[0] = line.trim()
      } else if (!acc[1] && line.trim()) {
        acc[1] = line.trim()
      } else if (!acc[2] && line.trim()) {
        acc[2] = line.trim()
      }
      return acc
    },
    [null, null, null]
  )

  return {
    story: story || '',
    optionA: optionAText || '',
    optionB: optionBText || '',
  }
}
